{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="chat-room" style="display: flex; flex-direction: column; height: 100%;">
    <div class="chat-header" data-conversation-id="{{ conversation.id }}">
        <img src="{% if conversation.avatar %}{{ conversation.avatar.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" class="avatar-small">
        <div class="chat-header-info" id="chat-title">
            <h4>
                {% if conversation.type == 'favorite' %}‚≠ê {% endif %}
                {{ conversation.name|default:'–õ–∏—á–Ω—ã–π —á–∞—Ç' }}
                {% if participant.is_pinned %}üìå{% endif %}
            </h4>
            <p>—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: {{ conversation.participants.count }}</p>
        </div>
        <div class="chat-header-actions">
            {% if conversation.type == 'group' and is_admin %}
                <button class="btn btn-secondary" id="invite-btn">üîó –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å</button>
            {% endif %}
            {% if is_admin or conversation.type == 'private' %}
                <a href="{% url 'chat:edit_channel' conversation.id %}" class="btn btn-secondary">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
            {% endif %}
            <a href="{% url 'chat:voice_room' conversation.id %}" class="btn btn-secondary">üéôÔ∏è –ì–æ–ª–æ—Å–æ–≤–æ–π –∫–∞–Ω–∞–ª</a>
            <a href="{% url 'chat:file_list' conversation.id %}" class="btn btn-secondary">üìÅ –§–∞–π–ª—ã</a>
        </div>
    </div>

    <!-- –ë–∞–Ω–Ω–µ—Ä –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è -->
    {% if pinned_message %}
    <div id="pinned-banner" onclick="document.getElementById('msg-{{ pinned_message.id }}').scrollIntoView({behavior: 'smooth'});">
        üìå –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ: {{ pinned_message.content|truncatechars:50 }}
    </div>
    {% else %}
    <div id="pinned-banner" style="display: none;"></div>
    {% endif %}

    <!-- –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é –∫–∞–Ω–∞–ª–∞ -->
    <div id="channel-menu" class="dropdown-menu" style="display: none;">
        <div class="dropdown-content">
            <h3>{{ conversation.name|default:'–ö–∞–Ω–∞–ª' }}</h3>
            <ul class="participants-list">
                {% for participant in conversation.participants.all %}
                <li>
                    <img src="{% if participant.avatar %}{{ participant.avatar.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" class="avatar-tiny">
                    {{ participant.get_display_name }}
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è -->
    <div id="invite-modal" style="display: none;">
        <h3>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</h3>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–±:</p>
        <button class="btn" id="copy-link">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
        <button class="btn" id="show-code">–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–¥</button>
        <p id="invite-result" style="margin-top: 10px;"></p>
        <button class="btn btn-secondary" onclick="document.getElementById('invite-modal').style.display='none'">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
    <div id="image-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 5000; align-items: center; justify-content: center;">
        <div style="max-width: 90%; max-height: 90%;">
            <img id="modal-image" style="max-width: 100%; max-height: 100%; object-fit: contain;">
        </div>
        <button id="modal-download" class="btn btn-primary" style="position: absolute; bottom: 20px; right: 20px;">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å</button>
        <button onclick="document.getElementById('image-modal').style.display='none'" class="btn btn-secondary" style="position: absolute; top: 20px; right: 20px;">‚úñ</button>
    </div>

    <!-- –ü–æ–ª–µ –ø–æ–∏—Å–∫–∞ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º -->
    <div class="search-messages">
        <input type="text" id="search-messages" placeholder="–ü–æ–∏—Å–∫ –≤ —á–∞—Ç–µ..." class="form-control">
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π -->
    <div class="messages" id="message-list">
        {% for message in messages %}
            {% if not message.deleted %}
            <div class="message {% if message.sender == user %}own{% endif %}" id="msg-{{ message.id }}" data-message-id="{{ message.id }}" data-sender-id="{{ message.sender.id }}">
                <img src="{% if message.sender.avatar %}{{ message.sender.avatar.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" class="avatar-tiny">
                <div class="message-bubble">
                    <span class="message-sender">{{ message.sender.get_display_name }}</span>
                    <div class="message-content">
                        {% if message.sticker %}
                            <img src="{{ message.sticker.image.url }}" alt="sticker" style="max-width: 128px; max-height: 128px;">
                        {% elif message.file %}
                            {% if message.file.file_type|slice:":5" == "image" or message.file.filename|lower|slice:"-4:" == ".jpg" or message.file.filename|lower|slice:"-4:" == ".png" or message.file.filename|lower|slice:"-5:" == ".jpeg" or message.file.filename|lower|slice:"-4:" == ".gif" or message.file.filename|lower|slice:"-5:" == ".webp" %}
                                <img src="{{ message.file.file.url }}" alt="image" class="chat-image" style="max-width: 200px; max-height: 200px; cursor: pointer;" onclick="openImageModal('{{ message.file.file.url }}', '{{ message.file.filename }}')">
                            {% else %}
                                <a href="{{ message.file.file.url }}" target="_blank">{{ message.file.filename }}</a>
                            {% endif %}
                        {% else %}
                            {{ message.content }}
                        {% endif %}
                        {% if message.edited_at %}
                            <span class="edited">(–∏–∑–º–µ–Ω–µ–Ω–æ)</span>
                        {% endif %}
                    </div>
                    <span class="message-time">{{ message.timestamp|time:"H:i" }}</span>
                </div>
            </div>
            {% endif %}
        {% empty %}
            <p style="text-align: center; color: var(--text-secondary);">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>
        {% endfor %}
    </div>

    <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∏ –∫–Ω–æ–ø–∫–∏ (–æ–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è) -->
    <div class="message-input">
        <button id="attach-file" class="attach-button">üìé</button>
        <div class="input-wrapper">
            <textarea id="chat-message" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
            <button id="send-message">‚û§</button>
        </div>
        <button id="emoji-button" class="emoji-button">üòä</button>
        <div id="emoji-picker"></div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å —Å—Ç–∏–∫–µ—Ä–æ–≤ -->
    <div id="sticker-panel">
        {% for pack in sticker_packs %}
            {% for sticker in pack.stickers.all %}
                <img src="{{ sticker.image.url }}" onclick="sendSticker({{ sticker.id }})" alt="sticker">
            {% endfor %}
        {% endfor %}
    </div>
</div>

<script>
    window.currentUserId = {{ user.id }};
    window.conversationId = {{ conversation.id }};

    // –ú–µ–Ω—é –∫–∞–Ω–∞–ª–∞
    document.getElementById('chat-title').addEventListener('click', function(e) {
        const menu = document.getElementById('channel-menu');
        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        e.stopPropagation();
    });

    document.addEventListener('click', function(e) {
        const menu = document.getElementById('channel-menu');
        if (!menu.contains(e.target) && e.target !== document.getElementById('chat-title')) {
            menu.style.display = 'none';
        }
    });

    // –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
    document.getElementById('invite-btn')?.addEventListener('click', function() {
        fetch("{% url 'chat:create_invite' conversation.id %}", {
            headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            const modal = document.getElementById('invite-modal');
            const result = document.getElementById('invite-result');
            modal.style.display = 'block';
            document.getElementById('copy-link').onclick = function() {
                navigator.clipboard.writeText(data.link).then(() => {
                    result.textContent = '–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!';
                }).catch(() => {
                    result.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
                });
            };
            document.getElementById('show-code').onclick = function() {
                result.textContent = '–ö–æ–¥: ' + data.token;
            };
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ');
        });
    });

    // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    function openImageModal(imageUrl, filename) {
        const modal = document.getElementById('image-modal');
        const modalImg = document.getElementById('modal-image');
        const downloadBtn = document.getElementById('modal-download');
        modalImg.src = imageUrl;
        downloadBtn.onclick = function() {
            const a = document.createElement('a');
            a.href = imageUrl;
            a.download = filename || 'image.jpg';
            a.click();
        };
        modal.style.display = 'flex';
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    document.getElementById('image-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    });

    // –°—Ç–∏–∫–µ—Ä—ã
    function sendSticker(stickerId) {
        fetch(`/chat/send_sticker/{{ conversation.id }}/${stickerId}/`, {
            method: 'POST',
            headers: {'X-CSRFToken': getCookie('csrftoken')}
        }).then(() => window.location.reload());
    }

    document.getElementById('sticker-btn')?.addEventListener('click', () => {
        const panel = document.getElementById('sticker-panel');
        panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    });

    // –ü–æ–∏—Å–∫ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º
    document.getElementById('search-messages').addEventListener('input', function(e) {
        const query = e.target.value.toLowerCase();
        document.querySelectorAll('#message-list .message').forEach(msg => {
            const text = msg.querySelector('.message-content').textContent.toLowerCase();
            msg.style.display = text.includes(query) ? 'flex' : 'none';
        });
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/contextmenu.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        initChatSocket(conversationId);
        const msgList = document.getElementById('message-list');
        if (msgList) {
            msgList.scrollTop = msgList.scrollHeight;
        }
    });
</script>
{% endblock %}