{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="chat-room" style="display: flex; flex-direction: column; height: 100%;">
    <div class="chat-header">
        <img src="{% if conversation.avatar %}{{ conversation.avatar.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" class="avatar-small">
        <div class="chat-header-info" id="chat-title">
            <h4>
                {% if conversation.type == 'favorite' %}‚≠ê {% endif %}
                {{ conversation.name|default:'–õ–∏—á–Ω—ã–π —á–∞—Ç' }}
            </h4>
            <p>—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: {{ conversation.participants.count }}</p>
        </div>
        <div class="chat-header-actions">
            {% if conversation.type == 'group' and is_admin %}
                <button class="btn btn-secondary" id="invite-btn">üîó –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å</button>
            {% endif %}
            {% if is_admin %}
                <a href="{% url 'chat:edit_channel' conversation.id %}" class="btn btn-secondary">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
            {% endif %}
            <a href="{% url 'chat:voice_room' conversation.id %}" class="btn btn-secondary">üéôÔ∏è –ì–æ–ª–æ—Å–æ–≤–æ–π –∫–∞–Ω–∞–ª</a>
        </div>
    </div>

    <!-- –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é –∫–∞–Ω–∞–ª–∞ -->
    <div id="channel-menu" class="dropdown-menu" style="display: none;">
        <div class="dropdown-content">
            <h3>{{ conversation.name|default:'–ö–∞–Ω–∞–ª' }}</h3>
            <ul class="participants-list">
                {% for participant in conversation.participants.all %}
                <li>
                    <img src="{% if participant.avatar %}{{ participant.avatar.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" class="avatar-tiny">
                    {{ participant.get_display_name }}
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è -->
    <div id="invite-modal" style="display: none;">
        <h3>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</h3>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–±:</p>
        <button class="btn" id="copy-link">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
        <button class="btn" id="show-code">–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–¥</button>
        <p id="invite-result" style="margin-top: 10px;"></p>
        <button class="btn btn-secondary" onclick="document.getElementById('invite-modal').style.display='none'">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <!-- –ü–æ–ª–µ –ø–æ–∏—Å–∫–∞ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º -->
    <div class="search-messages">
        <input type="text" id="search-messages" placeholder="–ü–æ–∏—Å–∫ –≤ —á–∞—Ç–µ..." class="form-control">
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π -->
    <div class="messages" id="message-list">
        {% for message in messages %}
            {% if not message.deleted %}
            <div class="message {% if message.sender == user %}own{% endif %}" id="msg-{{ message.id }}">
                <img src="{% if message.sender.avatar %}{{ message.sender.avatar.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" class="avatar-tiny">
                <div class="message-bubble">
                    <span class="message-sender">{{ message.sender.get_display_name }}</span>
                    <div class="message-content">
                        {% if message.sticker %}
                            <img src="{{ message.sticker.image.url }}" alt="sticker" style="max-width: 128px; max-height: 128px;">
                        {% elif message.file %}
                            <a href="{{ message.file.file.url }}" target="_blank">{{ message.file.filename }}</a>
                        {% else %}
                            {{ message.content }}
                        {% endif %}
                        {% if message.edited_at %}
                            <span class="edited">(–∏–∑–º–µ–Ω–µ–Ω–æ)</span>
                        {% endif %}
                    </div>
                    <span class="message-time">{{ message.timestamp|time:"H:i" }}</span>
                    {% if message.sender == user %}
                    <div class="message-actions">
                        <a href="{% url 'chat:edit_message' message.id %}" class="btn-edit">‚úé</a>
                        <button class="btn-delete" onclick="deleteMessage({{ message.id }})">üóëÔ∏è</button>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        {% empty %}
            <p style="text-align: center; color: var(--text-secondary);">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>
        {% endfor %}
    </div>

    <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∏ –∫–Ω–æ–ø–∫–∏ -->
    <div class="message-input">
        <textarea id="chat-message" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
        <button id="send-message">‚û§</button>
        <button id="sticker-btn" class="btn btn-secondary" style="margin-left: 5px;">üòä</button>
        <div id="emoji-picker"></div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å —Å—Ç–∏–∫–µ—Ä–æ–≤ -->
    <div id="sticker-panel">
        {% for pack in sticker_packs %}
            {% for sticker in pack.stickers.all %}
                <img src="{{ sticker.image.url }}" onclick="sendSticker({{ sticker.id }})" alt="sticker">
            {% endfor %}
        {% endfor %}
    </div>
</div>

<script>
    window.currentUserId = {{ user.id }};
    const conversationId = {{ conversation.id }};

    // –ú–µ–Ω—é –∫–∞–Ω–∞–ª–∞
    document.getElementById('chat-title').addEventListener('click', function(e) {
        const menu = document.getElementById('channel-menu');
        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        e.stopPropagation();
    });

    document.addEventListener('click', function(e) {
        const menu = document.getElementById('channel-menu');
        if (!menu.contains(e.target) && e.target !== document.getElementById('chat-title')) {
            menu.style.display = 'none';
        }
    });

    // –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
    document.getElementById('invite-btn')?.addEventListener('click', function() {
        fetch("{% url 'chat:create_invite' conversation.id %}", {
            headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            const modal = document.getElementById('invite-modal');
            const result = document.getElementById('invite-result');
            modal.style.display = 'block';
            document.getElementById('copy-link').onclick = function() {
                navigator.clipboard.writeText(data.link).then(() => {
                    result.textContent = '–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!';
                }).catch(() => {
                    result.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
                });
            };
            document.getElementById('show-code').onclick = function() {
                result.textContent = '–ö–æ–¥: ' + data.token;
            };
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ');
        });
    });

    // –°—Ç–∏–∫–µ—Ä—ã
    function sendSticker(stickerId) {
        fetch(`/chat/send_sticker/{{ conversation.id }}/${stickerId}/`, {
            method: 'POST',
            headers: {'X-CSRFToken': getCookie('csrftoken')}
        }).then(() => {
            // –ú–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ WebSocket, –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º
            window.location.reload();
        });
    }

    document.getElementById('sticker-btn')?.addEventListener('click', () => {
        const panel = document.getElementById('sticker-panel');
        panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    });

    // –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    function deleteMessage(messageId) {
        if (confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
            fetch(`/chat/delete_message/${messageId}/`, {
                method: 'POST',
                headers: {'X-CSRFToken': getCookie('csrftoken')}
            }).then(response => response.json()).then(data => {
                if (data.status === 'ok') {
                    document.getElementById('msg-' + messageId).remove();
                }
            });
        }
    }

    // –ü–æ–∏—Å–∫ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º
    document.getElementById('search-messages').addEventListener('input', function(e) {
        const query = e.target.value.toLowerCase();
        document.querySelectorAll('#message-list .message').forEach(msg => {
            const text = msg.querySelector('.message-content').textContent.toLowerCase();
            msg.style.display = text.includes(query) ? 'flex' : 'none';
        });
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        initChatSocket(conversationId);
        const msgList = document.getElementById('message-list');
        if (msgList) {
            msgList.scrollTop = msgList.scrollHeight;
        }
    });
</script>
{% endblock %}