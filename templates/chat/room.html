{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="chat-room" style="display: flex; flex-direction: column; height: 100%;">
    <div class="chat-header">
        <img src="{% if conversation.avatar %}{{ conversation.avatar.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" class="avatar-small">
        <div class="chat-header-info" id="chat-title">
            <h4>
                {% if conversation.type == 'favorite' %}‚≠ê {% endif %}
                {{ conversation.name|default:'–õ–∏—á–Ω—ã–π —á–∞—Ç' }}
            </h4>
            <p>—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: {{ conversation.participants.count }}</p>
        </div>
        <div class="chat-header-actions">
            {% if conversation.type == 'group' and is_admin %}
                <button class="btn btn-secondary" id="invite-btn">üîó –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å</button>
            {% endif %}
            {% if is_admin %}
                <a href="{% url 'chat:edit_channel' conversation.id %}" class="btn btn-secondary">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
            {% endif %}
        </div>
    </div>

    <!-- –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é –∫–∞–Ω–∞–ª–∞ -->
    <div id="channel-menu" class="dropdown-menu" style="display: none;">
        <div class="dropdown-content">
            <h3>{{ conversation.name|default:'–ö–∞–Ω–∞–ª' }}</h3>
            <ul class="participants-list">
                {% for participant in conversation.participants.all %}
                <li>
                    <img src="{% if participant.avatar %}{{ participant.avatar.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" class="avatar-tiny">
                    {{ participant.get_display_name }}
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è -->
    <div id="invite-modal" style="display: none;">
        <h3>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</h3>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–±:</p>
        <button class="btn" id="copy-link">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
        <button class="btn" id="show-code">–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–¥</button>
        <p id="invite-result" style="margin-top: 10px;"></p>
        <button class="btn btn-secondary" onclick="document.getElementById('invite-modal').style.display='none'">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div class="messages" id="message-list">
        {% for message in messages %}
        <div class="message {% if message.sender == user %}own{% endif %}" id="msg-{{ message.id }}">
            <img src="{% if message.sender.avatar %}{{ message.sender.avatar.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" class="avatar-tiny">
            <div class="message-bubble">
                <span class="message-sender">{{ message.sender.get_display_name }}</span>
                <div class="message-content">
                    {% if message.file %}
                        <a href="{{ message.file.file.url }}" target="_blank">{{ message.file.filename }}</a>
                    {% else %}
                        {{ message.content }}
                    {% endif %}
                </div>
                <span class="message-time">{{ message.timestamp|time:"H:i" }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="message-input">
        <textarea id="chat-message" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
        <button id="send-message">‚û§</button>
        <div id="emoji-picker"></div>
    </div>
</div>

<script>
    window.currentUserId = {{ user.id }};
    const conversationId = {{ conversation.id }};

    document.getElementById('chat-title').addEventListener('click', function(e) {
        const menu = document.getElementById('channel-menu');
        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        e.stopPropagation();
    });

    document.addEventListener('click', function(e) {
        const menu = document.getElementById('channel-menu');
        if (!menu.contains(e.target) && e.target !== document.getElementById('chat-title')) {
            menu.style.display = 'none';
        }
    });

    document.getElementById('invite-btn')?.addEventListener('click', function() {
        fetch("{% url 'chat:create_invite' conversation.id %}", {
            headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            const modal = document.getElementById('invite-modal');
            const result = document.getElementById('invite-result');
            modal.style.display = 'block';
            document.getElementById('copy-link').onclick = function() {
                navigator.clipboard.writeText(data.link).then(() => {
                    result.textContent = '–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!';
                }).catch(() => {
                    result.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
                });
            };
            document.getElementById('show-code').onclick = function() {
                result.textContent = '–ö–æ–¥: ' + data.token;
            };
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ');
        });
    });
</script>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        initChatSocket(conversationId);
        const msgList = document.getElementById('message-list');
        if (msgList) {
            msgList.scrollTop = msgList.scrollHeight;
        }
    });
</script>
{% endblock %}