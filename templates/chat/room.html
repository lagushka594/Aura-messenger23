{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="chat-room" style="display: flex; flex-direction: column; height: 100%;">
    <div class="chat-header">
        <img src="{% if conversation.avatar %}{{ conversation.avatar.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" class="avatar-small">
        <div class="chat-header-info">
            <h4>{{ conversation.name|default:'–õ–∏—á–Ω—ã–π —á–∞—Ç' }}</h4>
            <p>—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: {{ conversation.participants.count }}</p>
        </div>
        <div class="chat-header-actions">
            {% if conversation.type == 'group' and is_admin %}
                <button class="btn btn-secondary" id="invite-btn">üîó –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å</button>
            {% endif %}
            <a href="{% url 'chat:pin_chat' conversation.id %}" class="btn btn-secondary">
                {% if participant.is_pinned %}üìå –û—Ç–∫—Ä–µ–ø–∏—Ç—å{% else %}üìå –ó–∞–∫—Ä–µ–ø–∏—Ç—å{% endif %}
            </a>
            <a href="{% url 'chat:delete_chat' conversation.id %}" class="btn btn-danger" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç?')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</a>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è -->
    <div id="invite-modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--sidebar-bg); padding: 20px; border-radius: 12px; z-index: 2000; box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
        <h3>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</h3>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–±:</p>
        <button class="btn" id="copy-link">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
        <button class="btn" id="show-code">–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–¥</button>
        <p id="invite-result" style="margin-top: 10px;"></p>
        <button class="btn btn-secondary" onclick="document.getElementById('invite-modal').style.display='none'">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div class="messages" id="message-list">
        {% for message in messages %}
        <div class="message {% if message.sender == user %}own{% endif %}" id="msg-{{ message.id }}">
            <img src="{% if message.sender.avatar %}{{ message.sender.avatar.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" class="avatar-tiny">
            <div class="message-bubble">
                <span class="message-sender">{{ message.sender.get_display_name }}</span>
                <div class="message-content">{{ message.content }}</div>
                <span class="message-time">{{ message.timestamp|time:"H:i" }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="message-input">
        <textarea id="chat-message" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
        <button id="send-message">‚û§</button>
        <div id="emoji-picker"></div>
    </div>
</div>

<script>
    const conversationId = {{ conversation.id }};

    // –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ AJAX
    document.getElementById('invite-btn')?.addEventListener('click', function() {
        fetch("{% url 'chat:create_invite' conversation.id %}", {
            headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(response => response.json())
        .then(data => {
            const modal = document.getElementById('invite-modal');
            const result = document.getElementById('invite-result');
            modal.style.display = 'block';
            document.getElementById('copy-link').onclick = function() {
                navigator.clipboard.writeText(data.link);
                result.textContent = '–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!';
            };
            document.getElementById('show-code').onclick = function() {
                result.textContent = '–ö–æ–¥: ' + data.token;
            };
        });
    });
</script>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        initChatSocket(conversationId);
        const msgList = document.getElementById('message-list');
        if (msgList) {
            msgList.scrollTop = msgList.scrollHeight;
        }
    });
</script>
{% endblock %}