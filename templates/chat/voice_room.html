{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="voice-room" style="display: flex; flex-direction: column; height: 100%;">
    <div class="chat-header">
        <img src="{% if conversation.avatar %}{{ conversation.avatar.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" class="avatar-small">
        <div class="chat-header-info">
            <h4>üéôÔ∏è {{ voice_room.name }}</h4>
            <p>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ –≥–æ–ª–æ—Å–æ–≤–æ–º –∫–∞–Ω–∞–ª–µ: <span id="active-count">{{ voice_room.active_users.count }}</span></p>
        </div>
        <div class="chat-header-actions">
            <a href="{% url 'chat:room' conversation.id %}" class="btn btn-secondary">‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ —á–∞—Ç</a>
            {% if user in voice_room.active_users.all %}
                <a href="{% url 'chat:leave_voice' voice_room.id %}" class="btn btn-danger">–ü–æ–∫–∏–Ω—É—Ç—å</a>
            {% else %}
                <a href="{% url 'chat:join_voice' voice_room.id %}" class="btn btn-success">–í–æ–π—Ç–∏</a>
            {% endif %}
        </div>
    </div>

    <div class="voice-area" style="flex: 1; padding: 20px; background-color: var(--chat-bg);">
        <div class="participants-list" id="participants-list">
            <h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏:</h3>
            <ul>
                {% for participant in voice_room.active_users.all %}
                <li data-user-id="{{ participant.id }}">
                    <img src="{% if participant.avatar %}{{ participant.avatar.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" class="avatar-tiny">
                    {{ participant.get_display_name }}
                </li>
                {% empty %}
                <li>–ü–æ–∫–∞ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç</li>
                {% endfor %}
            </ul>
        </div>
        <div class="audio-controls" style="margin-top: 20px;">
            <p>–ì–æ–ª–æ—Å–æ–≤–∞—è —Å–≤—è–∑—å —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ WebRTC. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ä–∞–∑—Ä–µ—à–∏–ª–∏ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.</p>
            <button id="start-audio" class="btn btn-primary">–í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω</button>
            <button id="stop-audio" class="btn btn-danger" disabled>–í—ã–∫–ª—é—á–∏—Ç—å</button>
        </div>
    </div>
</div>

<script src="{% static 'js/webrtc.js' %}"></script>
<script>
    const voiceRoomId = {{ voice_room.id }};
    const currentUserId = {{ user.id }};
    document.addEventListener('DOMContentLoaded', function() {
        initVoiceSocket(voiceRoomId);
    });
</script>
{% endblock %}